<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashForge Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dynamic Animated Background with Schematic Pattern */
        body {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #1e293b, #312e81);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
        }

        /* Schematic/Technical Grid Overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
            background-image:
                /* Main grid */
                linear-gradient(rgba(100, 116, 139, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 116, 139, 0.3) 1px, transparent 1px),
                /* Finer grid */
                linear-gradient(rgba(100, 116, 139, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 116, 139, 0.15) 1px, transparent 1px),
                /* Circuit traces effect */
                repeating-linear-gradient(45deg, transparent, transparent 50px, rgba(59, 130, 246, 0.1) 50px, rgba(59, 130, 246, 0.1) 52px),
                repeating-linear-gradient(-45deg, transparent, transparent 50px, rgba(249, 115, 22, 0.1) 50px, rgba(249, 115, 22, 0.1) 52px);
            background-size:
                100px 100px,
                100px 100px,
                20px 20px,
                20px 20px,
                200px 200px,
                200px 200px;
            background-position:
                -1px -1px,
                -1px -1px,
                0 0,
                0 0,
                0 0,
                100px 100px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating orbs for depth */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, #f97316, #fb923c);
            top: -200px;
            right: -200px;
            animation: float 20s ease-in-out infinite;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            bottom: -150px;
            left: -150px;
            animation: float 25s ease-in-out infinite reverse;
        }

        .orb-3 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            top: 50%;
            left: 50%;
            animation: float 18s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -50px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* Content above background */
        main {
            position: relative;
            z-index: 1;
        }

        /* Enhanced card styling */
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            border-color: rgba(71, 85, 105, 0.8);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        /* Status card glow */
        .status-printing {
            box-shadow: 0 0 30px rgba(249, 115, 22, 0.3);
        }

        /* Temperature bar gradients */
        .temp-bar-nozzle {
            background: linear-gradient(90deg, #f97316 0%, #fb923c 50%, #fbbf24 100%);
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.5);
        }

        .temp-bar-bed {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Progress bar with glow */
        .progress-bar {
            background: linear-gradient(90deg, #f97316 0%, #fb923c 50%, #fbbf24 100%);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.6);
            transition: width 0.5s ease-in-out;
        }

        /* Pulse animation */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .pulse-dot {
            animation: pulse-dot 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Smooth transitions */
        * {
            transition-property: color, background-color, border-color, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }

        /* Glassmorphism header */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        /* Camera container */
        .camera-container {
            aspect-ratio: 16 / 9;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
        }

        /* Button hover effects */
        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.8);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.9);
        }

        /* Metric cards with color accents */
        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
        }

        /* Realistic Stop Sign */
        .stop-sign-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stop-sign {
            width: 52px;
            height: 52px;
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            background: #DC143C;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow:
                0 0 0 4px #FFFFFF,
                0 4px 12px rgba(220, 20, 60, 0.5),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .stop-sign::before {
            content: 'STOP';
            color: #FFFFFF;
            font-size: 11px;
            font-weight: 900;
            font-family: 'Arial Black', sans-serif;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .stop-sign:hover {
            background: #B91C1C;
            box-shadow:
                0 0 0 4px #FFFFFF,
                0 6px 20px rgba(220, 20, 60, 0.7),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: scale(1.08);
        }

        .stop-sign:active {
            transform: scale(0.98);
            box-shadow:
                0 0 0 4px #FFFFFF,
                0 2px 8px rgba(220, 20, 60, 0.5),
                inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .stop-sign-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(248, 113, 113, 0.9);
            font-weight: 700;
        }
    </style>
</head>
<body class="text-white min-h-screen">

    <!-- Animated Background Orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <!-- Technical Schematic Corner Markers -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 0; opacity: 0.15; pointer-events: none;">
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 0 L20 0 M0 0 L0 20" stroke="#60a5fa" stroke-width="2"/>
            <circle cx="5" cy="5" r="3" fill="#60a5fa"/>
            <text x="25" y="12" fill="#60a5fa" font-size="8" font-family="monospace">TL-01</text>
        </svg>
    </div>
    <div style="position: fixed; top: 20px; right: 20px; z-index: 0; opacity: 0.15; pointer-events: none;">
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 0 L40 0 M60 0 L60 20" stroke="#f97316" stroke-width="2"/>
            <circle cx="55" cy="5" r="3" fill="#f97316"/>
            <text x="5" y="12" fill="#f97316" font-size="8" font-family="monospace">TR-02</text>
        </svg>
    </div>
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 0; opacity: 0.15; pointer-events: none;">
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 60 L20 60 M0 60 L0 40" stroke="#8b5cf6" stroke-width="2"/>
            <circle cx="5" cy="55" r="3" fill="#8b5cf6"/>
            <text x="25" y="52" fill="#8b5cf6" font-size="8" font-family="monospace">BL-03</text>
        </svg>
    </div>
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 0; opacity: 0.15; pointer-events: none;">
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 60 L40 60 M60 60 L60 40" stroke="#10b981" stroke-width="2"/>
            <circle cx="55" cy="55" r="3" fill="#10b981"/>
            <text x="5" y="52" fill="#10b981" font-size="8" font-family="monospace">BR-04</text>
        </svg>
    </div>

    <!-- Compact Sticky Header -->
    <header class="h-16 glass sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto px-6 h-full flex items-center justify-between">

            <!-- Left: Branding & Printer Info -->
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold bg-gradient-to-r from-orange-400 to-orange-600 bg-clip-text text-transparent">
                    FlashForge
                </h1>
                <div class="h-6 w-px bg-slate-600"></div>
                <div class="flex items-center gap-2 text-sm text-slate-300">
                    <span class="font-medium">Adventurer 3</span>
                    <span>‚Ä¢</span>
                    <span class="font-mono text-blue-400">192.168.1.200</span>
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-4">
                <!-- Emergency Stop Sign -->
                <div class="stop-sign-container">
                    <button class="stop-sign" title="EMERGENCY HALT - Immediately stops all operations"></button>
                    <span class="stop-sign-label">Emergency</span>
                </div>

                <div class="h-8 w-px bg-slate-700"></div>

                <!-- User Menu Dropdown -->
                <div class="relative group">
                    <button class="flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600/50 rounded-lg text-sm backdrop-blur-sm">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold" id="user-avatar">
                            ?
                        </div>
                        <span id="user-email-short" class="text-slate-300">User</span>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-56 card rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                        <div class="p-3 border-b border-slate-700/50">
                            <div class="text-xs text-slate-500 mb-1">Signed in as</div>
                            <div id="user-email-full" class="text-sm text-slate-200 font-medium break-all">user@example.com</div>
                        </div>
                        <div class="p-2">
                            <button id="sign-out-btn" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm text-red-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="h-8 w-px bg-slate-700"></div>

                <!-- Resources Dropdown -->
                <div class="relative group">
                    <button class="flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600/50 rounded-lg text-sm backdrop-blur-sm">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span>Resources</span>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-56 card rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                        <div class="p-2">
                            <a href="https://www.printables.com" target="_blank" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm">
                                <span>üì¶</span>
                                <span>Printables</span>
                            </a>
                            <a href="https://www.thingiverse.com" target="_blank" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm">
                                <span>üîß</span>
                                <span>Thingiverse</span>
                            </a>
                            <a href="https://thangs.com" target="_blank" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm">
                                <span>üîç</span>
                                <span>Thangs Search</span>
                            </a>
                            <a href="https://cults3d.com" target="_blank" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm">
                                <span>‚≠ê</span>
                                <span>Cults3D</span>
                            </a>
                            <a href="https://www.myminifactory.com" target="_blank" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-600/50 rounded-md text-sm">
                                <span>üé®</span>
                                <span>MyMiniFactory</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Settings Button (hidden for non-admins) -->
                <button id="settings-btn" class="p-2 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600/50 rounded-lg backdrop-blur-sm" style="display: none;">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>

                <!-- Version Badge -->
                <span class="px-3 py-1 bg-slate-700/50 border border-slate-600/50 rounded-full text-xs text-slate-300 backdrop-blur-sm">v1.3.0</span>
            </div>
        </div>
    </header>

    <!-- Main Content - REBALANCED LAYOUT -->
    <main class="max-w-[1800px] mx-auto px-6 py-6">

        <!-- TOP ROW: Most Important Info (Status + Temps) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

            <!-- Status Overview - PRIORITY #1 -->
            <div class="card rounded-xl p-6 status-printing metric-card" style="color: #f97316">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-100">Printer Status</h2>
                    <div class="px-3 py-1 bg-orange-500/20 rounded-full text-xs font-medium text-orange-300">
                        LIVE
                    </div>
                </div>

                <!-- Large Status Display with VCR Controls -->
                <div class="flex items-center gap-6 mb-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-orange-500/30 to-orange-600/30 rounded-2xl flex items-center justify-center border border-orange-500/30">
                        <svg class="w-10 h-10 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <div class="text-3xl font-bold text-orange-400">PRINTING</div>
                            <!-- VCR-style control buttons (contextual based on state) -->
                            <div class="flex items-center gap-1.5 bg-slate-900/50 rounded-lg p-1.5 border border-slate-700/50">
                                <!-- Play/Resume - grayed out when printing -->
                                <button disabled class="w-9 h-9 bg-slate-800/50 border-2 border-slate-700/30 rounded flex items-center justify-center transition-all opacity-40 cursor-not-allowed" title="Resume (not available while printing)">
                                    <svg class="w-5 h-5 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                                <!-- Pause - active when printing -->
                                <button class="w-9 h-9 bg-slate-800/80 hover:bg-orange-900/50 border-2 border-orange-500/30 hover:border-orange-500/50 rounded flex items-center justify-center group transition-all" title="Pause Print">
                                    <svg class="w-5 h-5 text-orange-400 group-hover:text-orange-300" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                                    </svg>
                                </button>
                                <!-- Stop - active when printing (cancel print) -->
                                <button class="w-9 h-9 bg-slate-800/80 hover:bg-red-900/50 border-2 border-slate-600/50 hover:border-red-500/50 rounded flex items-center justify-center group transition-all" title="Cancel Print (normal stop)">
                                    <svg class="w-5 h-5 text-slate-400 group-hover:text-red-400" fill="currentColor" viewBox="0 0 24 24">
                                        <rect x="5" y="5" width="14" height="14"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-slate-400">Active for 1h 23m ‚Ä¢ 65% complete</div>
                    </div>
                </div>

                <!-- Quick Stats Grid -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                        <div class="text-xs text-slate-500 mb-1">Connection</div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                            <span class="text-sm font-medium text-green-400">Online</span>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                        <div class="text-xs text-slate-500 mb-1">Uptime</div>
                        <div class="text-sm font-mono font-medium text-slate-200">2h 34m</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                        <div class="text-xs text-slate-500 mb-1">Last Poll</div>
                        <div class="text-sm font-medium text-slate-200">2s ago</div>
                    </div>
                </div>

                <!-- Printer Controls -->
                <div class="mb-6">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-3">Printer Controls</div>
                    <div class="grid grid-cols-3 gap-3">
                        <button class="flex flex-col items-center gap-2 px-4 py-3 bg-gradient-to-br from-blue-500/20 to-blue-600/20 hover:from-blue-500/30 hover:to-blue-600/30 rounded-lg border border-blue-500/30">
                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                            </svg>
                            <span class="text-xs font-medium">Home</span>
                        </button>
                        <button class="flex flex-col items-center gap-2 px-4 py-3 bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 hover:from-yellow-500/30 hover:to-yellow-600/30 rounded-lg border border-yellow-500/30">
                            <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            <span class="text-xs font-medium">LED</span>
                        </button>
                        <button class="flex flex-col items-center gap-2 px-4 py-3 bg-gradient-to-br from-cyan-500/20 to-cyan-600/20 hover:from-cyan-500/30 hover:to-cyan-600/30 rounded-lg border border-cyan-500/30">
                            <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
                            </svg>
                            <span class="text-xs font-medium">Fan</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Temperature Card - PRIORITY #2 -->
            <div class="card rounded-xl p-6 metric-card" style="color: #3b82f6">
                <h2 class="text-lg font-semibold text-slate-100 mb-6">Temperatures</h2>

                <!-- Nozzle Temperature with Inline Controls -->
                <div class="mb-6 bg-slate-800/50 border border-slate-700/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500/20 to-orange-600/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-slate-500 mb-1">Nozzle</div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-2xl font-bold text-orange-400">210¬∞C</span>
                                <span class="text-sm text-slate-500">/ 210¬∞C</span>
                                <span class="text-xs text-green-400 ml-2">‚Üí At target</span>
                            </div>
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-900/50 rounded-full overflow-hidden mb-3">
                        <div class="absolute inset-y-0 left-0 temp-bar-nozzle rounded-full" style="width: 100%"></div>
                    </div>
                    <!-- Inline Controls -->
                    <div class="flex items-center gap-2">
                        <button class="w-8 h-8 bg-gradient-to-br from-orange-600/20 to-orange-700/20 hover:from-orange-600/30 hover:to-orange-700/30 border border-orange-500/30 rounded-lg font-bold flex items-center justify-center">‚àí</button>
                        <input type="number" value="210" min="0" max="300" step="5" class="flex-1 bg-slate-900/50 border border-slate-700/50 rounded-lg px-2 py-1.5 text-center font-mono text-sm font-bold text-orange-400 focus:outline-none focus:border-orange-500/50">
                        <button class="w-8 h-8 bg-gradient-to-br from-orange-600/20 to-orange-700/20 hover:from-orange-600/30 hover:to-orange-700/30 border border-orange-500/30 rounded-lg font-bold flex items-center justify-center">+</button>
                        <button class="px-3 py-1.5 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-500 hover:to-orange-600 rounded-lg text-xs font-bold border border-orange-500/50">Set</button>
                    </div>
                </div>

                <!-- Bed Temperature with Inline Controls -->
                <div class="mb-6 bg-slate-800/50 border border-slate-700/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-slate-500 mb-1">Bed</div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-2xl font-bold text-blue-400">60¬∞C</span>
                                <span class="text-sm text-slate-500">/ 60¬∞C</span>
                                <span class="text-xs text-green-400 ml-2">‚Üí At target</span>
                            </div>
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-900/50 rounded-full overflow-hidden mb-3">
                        <div class="absolute inset-y-0 left-0 temp-bar-bed rounded-full" style="width: 100%"></div>
                    </div>
                    <!-- Inline Controls -->
                    <div class="flex items-center gap-2">
                        <button class="w-8 h-8 bg-gradient-to-br from-blue-600/20 to-blue-700/20 hover:from-blue-600/30 hover:to-blue-700/30 border border-blue-500/30 rounded-lg font-bold flex items-center justify-center">‚àí</button>
                        <input type="number" value="60" min="0" max="120" step="5" class="flex-1 bg-slate-900/50 border border-slate-700/50 rounded-lg px-2 py-1.5 text-center font-mono text-sm font-bold text-blue-400 focus:outline-none focus:border-blue-500/50">
                        <button class="w-8 h-8 bg-gradient-to-br from-blue-600/20 to-blue-700/20 hover:from-blue-600/30 hover:to-blue-700/30 border border-blue-500/30 rounded-lg font-bold flex items-center justify-center">+</button>
                        <button class="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 rounded-lg text-xs font-bold border border-blue-500/50">Set</button>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="pt-4 border-t border-slate-700/50">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-3">Quick Presets</div>
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <button id="preset-pla" class="px-3 py-2 bg-gradient-to-br from-slate-700/50 to-slate-800/50 hover:from-orange-500/30 hover:to-orange-600/30 border border-slate-600/50 hover:border-orange-500/50 rounded-lg text-xs font-medium">
                            PLA
                        </button>
                        <button id="preset-petg" class="px-3 py-2 bg-gradient-to-br from-slate-700/50 to-slate-800/50 hover:from-orange-500/30 hover:to-orange-600/30 border border-slate-600/50 hover:border-orange-500/50 rounded-lg text-xs font-medium">
                            PETG
                        </button>
                        <button id="preset-abs" class="px-3 py-2 bg-gradient-to-br from-slate-700/50 to-slate-800/50 hover:from-orange-500/30 hover:to-orange-600/30 border border-slate-600/50 hover:border-orange-500/50 rounded-lg text-xs font-medium">
                            ABS
                        </button>
                        <button id="preset-asa" class="px-3 py-2 bg-gradient-to-br from-slate-700/50 to-slate-800/50 hover:from-orange-500/30 hover:to-orange-600/30 border border-slate-600/50 hover:border-orange-500/50 rounded-lg text-xs font-medium">
                            ASA
                        </button>
                    </div>
                    <button id="cooldown-all" class="w-full px-3 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 rounded-lg text-sm font-medium border border-blue-500/50">
                        Cool Down All
                    </button>
                </div>
            </div>
        </div>

        <!-- SECOND ROW: Progress + Camera (Balanced 50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

            <!-- Print Progress - PRIORITY #3 -->
            <div class="card rounded-xl p-6 metric-card" style="color: #f97316">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-slate-100">Print Progress</h2>
                    <div class="text-right">
                        <div class="text-4xl font-bold bg-gradient-to-r from-orange-400 to-orange-600 bg-clip-text text-transparent">65%</div>
                        <div class="text-xs text-slate-500">Complete</div>
                    </div>
                </div>

                <!-- Enhanced Progress Bar -->
                <div class="relative w-full h-4 bg-slate-900/50 rounded-full overflow-hidden mb-6 backdrop-blur-sm">
                    <div class="progress-bar absolute inset-y-0 left-0 rounded-full" style="width: 65%"></div>
                </div>

                <!-- File Info (dynamic: shows active print or no print message) -->
                <div id="print-info-container">
                    <!-- No active print state -->
                    <div id="no-print-state" class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-6 text-center" style="display: none;">
                        <svg class="w-12 h-12 mx-auto mb-3 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-slate-400 text-sm">No active print job</p>
                        <p class="text-slate-600 text-xs mt-1">Upload a G-code file to begin</p>
                    </div>

                    <!-- Active print state -->
                    <div id="active-print-state" style="display: none;">
                        <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div id="print-filename" class="font-medium text-slate-200 mb-1">‚Äî</div>
                                    <div class="text-xs text-slate-500">Active print job</div>
                                </div>
                            </div>

                            <!-- Time Stats -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-slate-900/50 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="text-xs text-slate-500">Time Remaining</span>
                                    </div>
                                    <div id="print-time-remaining" class="font-mono text-lg font-bold text-orange-400">‚Äî</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        <span class="text-xs text-slate-500">Progress</span>
                                    </div>
                                    <div id="print-progress-text" class="font-mono text-lg font-bold text-blue-400">‚Äî</div>
                                </div>
                            </div>
                        </div>

                        <!-- Layer & Material Stats -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-3">
                                <div class="text-xs text-slate-500 mb-1">Current Layer</div>
                                <div class="font-mono text-xl font-bold text-slate-200">‚Äî</div>
                                <div class="text-xs text-slate-500 mt-1">Not available from API</div>
                            </div>
                            <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-3">
                                <div class="text-xs text-slate-500 mb-1">Filament Used</div>
                                <div class="font-mono text-xl font-bold text-slate-200">‚Äî</div>
                                <div class="text-xs text-slate-500 mt-1">Not available from API</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Feed -->
            <div class="card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-100">Live Feed</h2>
                    <div class="flex items-center gap-2">
                        <button class="p-2 hover:bg-slate-700/50 rounded-lg" title="Take Snapshot">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                        <button class="p-2 hover:bg-slate-700/50 rounded-lg" title="Fullscreen">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="camera-container rounded-lg overflow-hidden relative border border-slate-700/50">
                    <!-- Camera Stream -->
                    <img id="camera-stream"
                         src="/api/camera/stream"
                         class="w-full h-full object-cover"
                         style="display: none;"
                         onerror="this.style.display='none'; document.getElementById('camera-placeholder').style.display='flex';"
                         onload="this.style.display='block'; document.getElementById('camera-placeholder').style.display='none';">

                    <!-- Placeholder (shown when camera unavailable) -->
                    <div id="camera-placeholder" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-3 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-slate-500 text-sm">Camera Stream</p>
                            <p class="text-slate-600 text-xs mt-1">Unavailable</p>
                        </div>
                    </div>

                    <!-- LIVE indicator -->
                    <div class="absolute top-3 left-3 flex items-center gap-2 px-3 py-1.5 bg-red-500/90 backdrop-blur-sm rounded-full">
                        <span class="w-2 h-2 rounded-full bg-white pulse-dot"></span>
                        <span class="text-xs font-bold text-white">LIVE</span>
                    </div>

                    <!-- Timestamp -->
                    <div class="absolute bottom-3 right-3 px-3 py-1.5 bg-slate-900/80 backdrop-blur-sm rounded-lg border border-slate-700/50">
                        <span id="camera-timestamp" class="text-xs font-mono text-slate-300">00:00:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- THIRD ROW: File Management (Full Width) -->
        <div class="grid grid-cols-1 gap-6">

            <!-- File Management (Compact Full-Width) -->
            <div class="card rounded-xl p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: Header & Tabs -->
                    <div class="lg:col-span-1">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-slate-100">File Management</h2>
                            <button class="p-2 hover:bg-slate-700/50 rounded-lg">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Tab Switcher -->
                        <div class="flex gap-2 p-1 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            <button class="flex-1 py-2 px-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-md text-sm font-medium shadow-lg">
                                Upload New
                            </button>
                            <button class="flex-1 py-2 px-3 text-slate-400 rounded-md text-sm font-medium hover:bg-slate-800/50">
                                Internal Memory
                            </button>
                        </div>
                    </div>

                    <!-- Middle: Upload Zone -->
                    <div class="lg:col-span-1">
                        <input type="file" id="gcode-file-input" accept=".gcode,.gco,.g" style="display: none;">
                        <div id="upload-zone" class="border-2 border-dashed border-slate-600/50 hover:border-purple-500/50 rounded-lg p-6 text-center cursor-pointer bg-slate-900/30 h-full flex flex-col items-center justify-center transition-all">
                            <div class="w-14 h-14 mb-3 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <p id="upload-text" class="text-slate-300 text-sm font-medium mb-1">Drop G-code or click</p>
                            <p id="upload-subtext" class="text-slate-500 text-xs">Max 100 MB</p>
                        </div>
                    </div>

                    <!-- Right: Start Button & Info -->
                    <div class="lg:col-span-1 flex flex-col justify-center">
                        <button class="w-full px-4 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 rounded-lg font-bold flex items-center justify-center gap-2 border border-green-500/50 shadow-lg shadow-green-500/20 mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            START PRINT
                        </button>
                        <div class="text-xs text-slate-500 text-center">
                            Select or upload G-code to begin
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Load user info and update UI
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();

                if (data.authenticated && data.email) {
                    // Update user menu
                    const email = data.email;
                    const initial = email.charAt(0).toUpperCase();

                    document.getElementById('user-avatar').textContent = initial;
                    document.getElementById('user-email-short').textContent = email.split('@')[0];
                    document.getElementById('user-email-full').textContent = email;

                    // Show settings button only for admins
                    if (data.is_admin) {
                        document.getElementById('settings-btn').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // API functions
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }


        async function sendControl(command) {
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                fetchStatus();
            } catch (error) {
                console.error('Error sending control:', error);
            }
        }

        async function setTemperature(target, temperature) {
            try {
                await fetch('/api/temperature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target, temperature })
                });
            } catch (error) {
                console.error('Error setting temperature:', error);
            }
        }

        // Get status styling based on printer state
        function getStatusStyle(status) {
            const styles = {
                'idle': { color: 'text-slate-400', label: 'IDLE' },
                'preheating': { color: 'text-yellow-400', label: 'PREHEATING' },
                'heating': { color: 'text-orange-400', label: 'HEATING' },
                'cooling': { color: 'text-blue-400', label: 'COOLING' },
                'ready': { color: 'text-green-400', label: 'READY' },
                'printing': { color: 'text-orange-400', label: 'PRINTING' },
                'paused': { color: 'text-yellow-400', label: 'PAUSED' },
                'complete': { color: 'text-green-400', label: 'COMPLETE' },
                'error': { color: 'text-red-400', label: 'ERROR' },
                'disconnected': { color: 'text-red-400', label: 'DISCONNECTED' }
            };
            return styles[status.toLowerCase()] || styles['idle'];
        }

        // Update UI with status data
        function updateUI(data) {
            // Status with dynamic styling
            const statusText = document.querySelector('.text-3xl.font-bold.text-orange-400');
            if (statusText) {
                const style = getStatusStyle(data.status);
                statusText.textContent = style.label;
                // Update color class
                statusText.className = `text-3xl font-bold ${style.color}`;
            }

            // Connection status
            const connectionDot = document.querySelector('.bg-green-500.pulse-dot');
            const connectionText = connectionDot?.nextElementSibling;
            if (connectionDot && connectionText) {
                if (data.connected) {
                    connectionDot.className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
                    connectionText.textContent = 'Online';
                    connectionText.className = 'text-sm font-medium text-green-400';
                } else {
                    connectionDot.className = 'w-2 h-2 rounded-full bg-red-500';
                    connectionText.textContent = 'Offline';
                    connectionText.className = 'text-sm font-medium text-red-400';
                }
            }

            // Temperatures
            const nozzleTempElements = document.querySelectorAll('.text-2xl.font-bold.text-orange-400');
            if (nozzleTempElements[0]) {
                nozzleTempElements[0].textContent = `${Math.round(data.nozzle_temp)}¬∞C`;
                const nozzleTarget = nozzleTempElements[0].nextElementSibling;
                if (nozzleTarget) nozzleTarget.textContent = `/ ${Math.round(data.nozzle_target)}¬∞C`;
            }

            const bedTempElements = document.querySelectorAll('.text-2xl.font-bold.text-blue-400');
            if (bedTempElements[0]) {
                bedTempElements[0].textContent = `${Math.round(data.bed_temp)}¬∞C`;
                const bedTarget = bedTempElements[0].nextElementSibling;
                if (bedTarget) bedTarget.textContent = `/ ${Math.round(data.bed_target)}¬∞C`;
            }

            // Temperature bars
            const nozzleBar = document.querySelector('.temp-bar-nozzle');
            if (nozzleBar && data.nozzle_target > 0) {
                const nozzlePercent = Math.min(100, (data.nozzle_temp / data.nozzle_target) * 100);
                nozzleBar.style.width = `${nozzlePercent}%`;
            }

            const bedBar = document.querySelector('.temp-bar-bed');
            if (bedBar && data.bed_target > 0) {
                const bedPercent = Math.min(100, (data.bed_temp / data.bed_target) * 100);
                bedBar.style.width = `${bedPercent}%`;
            }

            // Progress
            const progressPercent = document.querySelector('.text-4xl.font-bold.bg-gradient-to-r');
            if (progressPercent) progressPercent.textContent = `${data.progress}%`;

            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) progressBar.style.width = `${data.progress}%`;

            // Print progress card - toggle between active print and no print states
            const noPrintState = document.getElementById('no-print-state');
            const activePrintState = document.getElementById('active-print-state');

            if (data.gcode_filename) {
                // Active print - show print info
                if (noPrintState) noPrintState.style.display = 'none';
                if (activePrintState) activePrintState.style.display = 'block';

                // Update filename
                const printFilename = document.getElementById('print-filename');
                if (printFilename) printFilename.textContent = data.gcode_filename;

                // Update time remaining
                const timeRemaining = document.getElementById('print-time-remaining');
                if (timeRemaining && data.time_remaining_formatted) {
                    timeRemaining.textContent = data.time_remaining_formatted.substring(0, data.time_remaining_formatted.lastIndexOf(':'));
                }

                // Update progress text
                const progressText = document.getElementById('print-progress-text');
                if (progressText) progressText.textContent = `${data.progress}%`;
            } else {
                // No active print - show placeholder
                if (noPrintState) noPrintState.style.display = 'block';
                if (activePrintState) activePrintState.style.display = 'none';
            }

            // Update button states based on printer status
            updateButtonStates(data.status);
        }

        function updateButtonStates(status) {
            const playBtn = document.querySelector('button[title*="Resume"]');
            const pauseBtn = document.querySelector('button[title*="Pause"]');
            const stopBtn = document.querySelector('button[title*="Cancel Print"]');

            const statusLower = status.toLowerCase();

            if (statusLower === 'printing') {
                // Disable play, enable pause/stop
                if (playBtn) {
                    playBtn.disabled = true;
                    playBtn.classList.add('opacity-40', 'cursor-not-allowed');
                }
                if (pauseBtn) {
                    pauseBtn.disabled = false;
                    pauseBtn.classList.remove('opacity-40', 'cursor-not-allowed');
                }
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.classList.remove('opacity-40', 'cursor-not-allowed');
                }
            } else if (statusLower === 'paused') {
                // Enable play, disable pause, enable stop
                if (playBtn) {
                    playBtn.disabled = false;
                    playBtn.classList.remove('opacity-40', 'cursor-not-allowed');
                }
                if (pauseBtn) {
                    pauseBtn.disabled = true;
                    pauseBtn.classList.add('opacity-40', 'cursor-not-allowed');
                }
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.classList.remove('opacity-40', 'cursor-not-allowed');
                }
            } else {
                // Idle, preheating, heating, cooling, ready, etc. - disable all print controls
                if (playBtn) {
                    playBtn.disabled = true;
                    playBtn.classList.add('opacity-40', 'cursor-not-allowed');
                }
                if (pauseBtn) {
                    pauseBtn.disabled = true;
                    pauseBtn.classList.add('opacity-40', 'cursor-not-allowed');
                }
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.classList.add('opacity-40', 'cursor-not-allowed');
                }
            }
        }


        // Wire up control buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Load user info
            loadUserInfo();

            // Sign out button
            const signOutBtn = document.getElementById('sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async () => {
                    try {
                        await fetch('/auth/logout', { method: 'POST' });
                        window.location.href = '/login.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                    }
                });
            }

            // Emergency stop
            const emergencyStop = document.querySelector('.stop-sign');
            if (emergencyStop) {
                emergencyStop.addEventListener('click', () => {
                    if (confirm('EMERGENCY STOP: This will immediately halt all printer operations. Continue?')) {
                        sendControl('emergency_stop');
                    }
                });
            }

            // VCR controls
            const playBtn = document.querySelector('button[title*="Resume"]');
            if (playBtn) {
                playBtn.addEventListener('click', () => sendControl('resume'));
            }

            const pauseBtn = document.querySelector('button[title*="Pause"]');
            if (pauseBtn) {
                pauseBtn.addEventListener('click', () => sendControl('pause'));
            }

            const stopBtn = document.querySelector('button[title*="Cancel Print"]');
            if (stopBtn) {
                stopBtn.addEventListener('click', () => {
                    if (confirm('Cancel the current print job?')) {
                        sendControl('stop');
                    }
                });
            }

            // LED control
            // Home button
            const homeBtn = document.querySelector('button .text-blue-400')?.closest('button');
            if (homeBtn) {
                homeBtn.addEventListener('click', () => {
                    if (confirm('Home all axes? The print head will move to the home position.')) {
                        sendControl('home_axes');
                    }
                });
            }

            // LED control
            const ledBtn = document.querySelector('button .text-yellow-400')?.closest('button');
            if (ledBtn) {
                ledBtn.addEventListener('click', async () => {
                    // Toggle LED - we'll fetch status first to know current state
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    sendControl(data.led_on ? 'led_off' : 'led_on');
                });
            }

            // Fan button
            const fanBtn = document.querySelector('button .text-cyan-400')?.closest('button');
            if (fanBtn) {
                fanBtn.addEventListener('click', async () => {
                    // For now, just toggle fan on (printer might not report fan status)
                    // Could be enhanced to track state if needed
                    sendControl('fan_on');
                });
            }

            // Temperature controls
            setupTempControls();
            setupPresetButtons();

            // Settings button
            const settingsBtn = document.querySelector('button .text-purple-400')?.closest('button');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    window.location.href = '/settings.html';
                });
            }

            // Camera snapshot button
            const snapshotBtn = document.querySelector('button[title="Take Snapshot"]');
            if (snapshotBtn) {
                snapshotBtn.addEventListener('click', async () => {
                    const response = await fetch('/api/camera');
                    const data = await response.json();
                    window.open(data.snapshot_url, '_blank');
                });
            }

            // Camera fullscreen button
            const fullscreenBtn = document.querySelector('button[title="Fullscreen"]');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    const cameraContainer = document.querySelector('.camera-container');
                    if (cameraContainer) {
                        if (cameraContainer.requestFullscreen) {
                            cameraContainer.requestFullscreen();
                        } else if (cameraContainer.webkitRequestFullscreen) {
                            cameraContainer.webkitRequestFullscreen();
                        } else if (cameraContainer.msRequestFullscreen) {
                            cameraContainer.msRequestFullscreen();
                        }
                    }
                });
            }

            // File refresh button
            const fileRefreshBtn = document.querySelector('button .text-purple-400')?.parentElement;
            if (fileRefreshBtn && fileRefreshBtn.querySelector('path[d*="M4 4v5"]')) {
                fileRefreshBtn.addEventListener('click', async () => {
                    console.log('Refreshing file list...');
                    // This would refresh the file list from printer's SD card
                    // Currently file management UI shows upload only
                    // Could be expanded to show SD card files when that tab is implemented
                });
            }

            // Start periodic updates
            fetchStatus();
            setInterval(fetchStatus, 2000);

            // Update camera timestamp
            updateCameraTimestamp();
            setInterval(updateCameraTimestamp, 1000);

            // File Upload Functionality
            setupFileUpload();

            // START PRINT button
            const startPrintBtn = document.querySelector('button svg[viewBox="0 0 24 24"] path[d*="M14.752"]')?.closest('button');
            if (startPrintBtn) {
                startPrintBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();

                        if (data.gcode_filename) {
                            if (confirm(`Start printing ${data.gcode_filename}?`)) {
                                const printResponse = await fetch('/api/files/print', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ filename: data.gcode_filename })
                                });
                                const result = await printResponse.json();
                                if (result.success) {
                                    console.log('Print started successfully');
                                    fetchStatus();
                                } else {
                                    alert('Failed to start print: ' + result.message);
                                }
                            }
                        } else {
                            alert('No file loaded. Please upload a G-code file first.');
                        }
                    } catch (error) {
                        console.error('Error starting print:', error);
                        alert('Error starting print');
                    }
                });
            }
        });

        function updateCameraTimestamp() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timestamp = document.getElementById('camera-timestamp');
            if (timestamp) {
                timestamp.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }

        function setupTempControls() {
            // Nozzle temp controls
            const nozzleInput = document.querySelector('input[value="210"]');
            const nozzleMinus = nozzleInput?.previousElementSibling;
            const nozzlePlus = nozzleInput?.nextElementSibling;
            const nozzleSet = nozzlePlus?.nextElementSibling;

            if (nozzleMinus) {
                nozzleMinus.addEventListener('click', () => {
                    nozzleInput.value = Math.max(0, parseInt(nozzleInput.value) - 5);
                });
            }

            if (nozzlePlus) {
                nozzlePlus.addEventListener('click', () => {
                    nozzleInput.value = Math.min(300, parseInt(nozzleInput.value) + 5);
                });
            }

            if (nozzleSet) {
                nozzleSet.addEventListener('click', () => {
                    setTemperature('nozzle', parseInt(nozzleInput.value));
                });
            }

            // Bed temp controls
            const bedInput = document.querySelector('input[value="60"]');
            const bedMinus = bedInput?.previousElementSibling;
            const bedPlus = bedInput?.nextElementSibling;
            const bedSet = bedPlus?.nextElementSibling;

            if (bedMinus) {
                bedMinus.addEventListener('click', () => {
                    bedInput.value = Math.max(0, parseInt(bedInput.value) - 5);
                });
            }

            if (bedPlus) {
                bedPlus.addEventListener('click', () => {
                    bedInput.value = Math.min(120, parseInt(bedInput.value) + 5);
                });
            }

            if (bedSet) {
                bedSet.addEventListener('click', () => {
                    setTemperature('bed', parseInt(bedInput.value));
                });
            }
        }

        function setupFileUpload() {
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('gcode-file-input');
            const uploadText = document.getElementById('upload-text');
            const uploadSubtext = document.getElementById('upload-subtext');

            if (!uploadZone || !fileInput) return;

            // Click to select file
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            // Handle file selection
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            // Drag and drop handlers
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('border-purple-500');
                uploadZone.classList.remove('border-slate-600/50');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('border-purple-500');
                uploadZone.classList.add('border-slate-600/50');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('border-purple-500');
                uploadZone.classList.add('border-slate-600/50');

                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            async function handleFileUpload(file) {
                // Validate file type
                const validExtensions = ['.gcode', '.gco', '.g'];
                const fileName = file.name.toLowerCase();
                const isValid = validExtensions.some(ext => fileName.endsWith(ext));

                if (!isValid) {
                    alert('Invalid file type. Please upload a G-code file (.gcode, .gco, .g)');
                    return;
                }

                // Validate file size (100MB)
                const maxSize = 100 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert('File too large. Maximum size is 100MB');
                    return;
                }

                // Update UI to show uploading
                uploadText.textContent = 'Uploading...';
                uploadSubtext.textContent = file.name;
                uploadZone.classList.add('opacity-50', 'pointer-events-none');

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_to_printer', 'false');
                    formData.append('start_print', 'false');

                    const response = await fetch('/api/gcode/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Success
                        uploadText.textContent = '‚úì Upload complete';
                        uploadSubtext.textContent = file.name;

                        // Show success message for 2 seconds, then reset
                        setTimeout(() => {
                            uploadText.textContent = 'Drop G-code or click';
                            uploadSubtext.textContent = 'Max 100 MB';
                            uploadZone.classList.remove('opacity-50', 'pointer-events-none');
                        }, 2000);

                        // Refresh status to update UI
                        fetchStatus();
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);

                    // Reset UI
                    uploadText.textContent = 'Drop G-code or click';
                    uploadSubtext.textContent = 'Max 100 MB';
                    uploadZone.classList.remove('opacity-50', 'pointer-events-none');
                }

                // Clear file input
                fileInput.value = '';
            }
        }

        async function setupPresetButtons() {
            // Material presets with default values
            const defaultPresets = {
                pla: { nozzle: 200, bed: 60 },
                petg: { nozzle: 235, bed: 80 },
                abs: { nozzle: 230, bed: 100 },
                asa: { nozzle: 240, bed: 100 }
            };

            // Try to load presets from backend config
            let presets = defaultPresets;
            try {
                const response = await fetch('/api/config/full');
                if (response.ok) {
                    const config = await response.json();
                    if (config.material_presets) {
                        presets = config.material_presets;
                    }
                }
            } catch (error) {
                console.log('Using default presets:', error);
            }

            // Wire up preset buttons
            const presetButtons = ['pla', 'petg', 'abs', 'asa'];
            presetButtons.forEach(material => {
                const btn = document.getElementById(`preset-${material}`);
                if (btn && presets[material]) {
                    btn.addEventListener('click', async () => {
                        const preset = presets[material];
                        try {
                            // Set nozzle temperature
                            await setTemperature('nozzle', preset.nozzle);
                            // Set bed temperature
                            await setTemperature('bed', preset.bed);

                            // Update input fields
                            const nozzleInput = document.querySelector('input[min="0"][max="300"]');
                            const bedInput = document.querySelector('input[min="0"][max="120"]');
                            if (nozzleInput) nozzleInput.value = preset.nozzle;
                            if (bedInput) bedInput.value = preset.bed;

                            console.log(`Applied ${material.toUpperCase()} preset: Nozzle ${preset.nozzle}¬∞C, Bed ${preset.bed}¬∞C`);
                        } catch (error) {
                            console.error(`Error applying ${material} preset:`, error);
                        }
                    });
                }
            });

            // Wire up cool down button
            const cooldownBtn = document.getElementById('cooldown-all');
            if (cooldownBtn) {
                cooldownBtn.addEventListener('click', async () => {
                    try {
                        // Set both to 0
                        await setTemperature('nozzle', 0);
                        await setTemperature('bed', 0);

                        // Update input fields
                        const nozzleInput = document.querySelector('input[min="0"][max="300"]');
                        const bedInput = document.querySelector('input[min="0"][max="120"]');
                        if (nozzleInput) nozzleInput.value = 0;
                        if (bedInput) bedInput.value = 0;

                        console.log('Cooling down all heaters');
                    } catch (error) {
                        console.error('Error cooling down:', error);
                    }
                });
            }
        }
    </script>

</body>
</html>
